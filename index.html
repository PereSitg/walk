<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SitgesWalk Pro - Pere Badia i Lorenz</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0056b3; --accent: #28a745; --bg: #f0f2f5; --card: #ffffff; --radius: 18px; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background-color: var(--bg); color: #1c1e21; padding-bottom: 180px; }

        .screen { display: none; min-height: 100vh; padding: 20px; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }

        #splash { background: linear-gradient(135deg, #0056b3, #007bff); color: white; justify-content: center; text-align: center; }
        .loader { border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .container { width: 100%; max-width: 400px; }
        .card { background: var(--card); border-radius: var(--radius); padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; margin-bottom: 15px; }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; margin-bottom: 8px; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-outline { background: white; border: 2px solid #ddd; }

        #global-chatbot {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 2px solid var(--primary);
            padding: 10px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            display: none;
        }
        #chat-log { height: 80px; overflow-y: auto; font-size: 0.85rem; background: #f8f9fa; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; }
        .chat-input-area { display: flex; gap: 5px; }
        #chat-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }

        #map-container { width: 100%; height: 220px; border-radius: 12px; overflow: hidden; border: 1px solid #ddd; margin: 10px 0; background: #eee; }
        .ok { color: var(--accent) !important; font-weight: bold; }
    </style>
</head>
<body>

    <div id="splash" class="screen active">
        <h1>SitgesWalk</h1>
        <p>by Pere Badia i Lorenz</p>
        <div class="loader"></div>
    </div>

    <div id="setup" class="screen">
        <div class="container">
            <h2 style="text-align:center">Configuraci√≥</h2>
            <button class="btn btn-success" onclick="activarTot()">‚úÖ ACTIVAR TOT DE COP</button>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0;">
                <button class="btn btn-outline" onclick="demanarPermis('gps')">üåç GPS</button>
                <button class="btn btn-outline" onclick="demanarPermis('camera')">üì∑ C√†mera</button>
                <button class="btn btn-outline" onclick="demanarPermis('micro')">üéôÔ∏è Micro</button>
                <button class="btn btn-outline" onclick="demanarPermis('galeria')">üñºÔ∏è Galeria</button>
            </div>
            <div class="card" style="font-size: 0.8rem;">
                <div id="st-gps">Ubicaci√≥: <span>PENDENT</span></div>
                <div id="st-camera">C√†mera: <span>PENDENT</span></div>
                <div id="st-micro">Micro: <span>PENDENT</span></div>
                <div id="st-galeria">Galeria: <span>PENDENT</span></div>
            </div>
            <button class="btn btn-main" onclick="canviarPantalla('setup', 'ruta-select')">CONTINUAR ‚ûî</button>
        </div>
    </div>

    <div id="ruta-select" class="screen">
        <div class="container">
            <h2>Quina ruta vols fer?</h2>
            <div class="card">
                <button class="btn btn-outline" onclick="comencarApp('30min')">‚è±Ô∏è 30 minuts</button>
                <button class="btn btn-outline" onclick="comencarApp('1h')">üö∂ 1 hora</button>
                <button class="btn btn-outline" onclick="comencarApp('2h')">üëü 2 hores</button>
                <button class="btn btn-main" onclick="comencarApp('completa')">‚≠ê Ruta Completa</button>
            </div>
        </div>
    </div>

    <div id="main" class="screen">
        <div class="container">
            <div class="card">
                <h3 id="mon-nom" style="margin:0">Calculant ruta...</h3>
                <div id="map-container">
                    <iframe id="mini-mapa" width="100%" height="100%" frameborder="0" style="border:0"></iframe>
                </div>
                <p id="mon-desc" style="font-size: 0.9rem; border-left: 4px solid var(--primary); padding-left: 10px;">
                    Esperant senyal de GPS per guiar-te.
                </p>
                <button class="btn btn-main" onclick="identificarPerGPS()">üìç RE-LOCALITZAR GPS</button>
            </div>
        </div>
    </div>

    <div id="global-chatbot">
        <div id="chat-log">ü§ñ Hola Pere! Soc el teu guia. Digues "Hola" o demana'm informaci√≥.</div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Escriu aqu√≠...">
            <button class="btn btn-main" style="width:50px; margin:0" onclick="enviarXat()">‚úàÔ∏è</button>
            <button class="btn btn-success" style="width:50px; margin:0" onclick="escoltarVeu()">üé§</button>
        </div>
    </div>

    <script>
        // --- DADES I L√íGICA DE DIST√ÄNCIA ---
        const DESTI = { nom: "Esgl√©sia de Sant Bartomeu", lat: 41.2355, lon: 1.8123 };
        let distanciaActual = null;

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371000; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // --- MOTOR DEL CHATBOT ---
        function generarResposta(pregunta) {
            const p = pregunta.toLowerCase();
            if (p.includes("hola")) return "Hola Pere! Soc el teu guia. Estic calculant la millor ruta.";
            if (p.includes("quant falta") || p.includes("dist√†ncia")) {
                return distanciaActual ? `Falten aproximadament ${Math.round(distanciaActual)} metres per arribar.` : "Encara no tinc la teva posici√≥.";
            }
            if (p.includes("esgl√©sia")) return "L'esgl√©sia √©s del segle XVII, estil barroc. Est√† dalt d'un tur√≥ mirant al mar.";
            return "Vols saber m√©s sobre Sitges? Pregunta'm el que vulguis.";
        }

        // --- NAVEGACI√ì ---
        setTimeout(() => {
            document.getElementById('splash').classList.remove('active');
            document.getElementById('setup').classList.add('active');
            document.getElementById('global-chatbot').style.display = 'block';
            revisarPermisos();
        }, 3000);

        function canviarPantalla(actual, seguent) {
            document.getElementById(actual).classList.remove('active');
            document.getElementById(seguent).classList.add('active');
        }

        function comencarApp(temps) {
            canviarPantalla('ruta-select', 'main');
            identificarPerGPS();
        }

        // --- GPS I MAPA ---
        function identificarPerGPS() {
            navigator.geolocation.getCurrentPosition((p) => {
                const lat = p.coords.latitude;
                const lon = p.coords.longitude;
                distanciaActual = calcularDistancia(lat, lon, DESTI.lat, DESTI.lon);
                
                // Actualitzem Mapa H√≠brid
                const url = `https://www.google.com/maps/embed/v1/view?key=YOUR_API_KEY_HERE&center=${lat},${lon}&zoom=18&maptype=satellite`; 
                // Nota: Per evitar errors de clau, usem el format d'embed directe sense clau si √©s possible o el placeholder
                document.getElementById('mini-mapa').src = `https://maps.google.com/maps?q=${lat},${lon}&t=k&z=18&output=embed`;

                const titol = document.getElementById('mon-nom');
                const desc = document.getElementById('mon-desc');

                if (distanciaActual < 30) {
                    titol.innerText = "üìç Arribat: " + DESTI.nom;
                    desc.innerText = "Benvingut! Aquest monument del segle XVII √©s el cor de Sitges.";
                    parlar("Ja hem arribat a l'esgl√©sia. Vols que t'expliqui la seva hist√≤ria?");
                } else {
                    titol.innerText = "üö∂ En cam√≠ cap a: " + DESTI.nom;
                    desc.innerText = `Ets a uns ${Math.round(distanciaActual)} metres. Continua caminant pel Passeig.`;
                    parlar(`Anirem cap a l'esgl√©sia. Falten ${Math.round(distanciaActual)} metres.`);
                }
                marcarOK('gps');
            });
        }

        // --- SISTEMA DE XAT ---
        function enviarXat() {
            const i = document.getElementById('chat-input');
            const text = i.value.trim();
            if(!text) return;
            afegirAlLog(text, "Tu");
            const r = generarResposta(text);
            setTimeout(() => { afegirAlLog(r, "ü§ñ"); parlar(r); }, 600);
            i.value = "";
        }

        function afegirAlLog(t, a) {
            const l = document.getElementById('chat-log');
            l.innerHTML += `<div><b>${a}:</b> ${t}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        function parlar(t) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'ca-ES';
            window.speechSynthesis.speak(u);
        }

        function escoltarVeu() {
            const rec = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
            rec.lang = 'ca-ES';
            rec.onresult = (e) => { document.getElementById('chat-input').value = e.results[0][0].transcript; enviarXat(); };
            rec.start();
        }

        function demanarPermis(t) { t === 'gps' ? identificarPerGPS() : marcarOK(t); }
        function marcarOK(t) { 
            const s = document.querySelector(`#st-${t} span`);
            if(s) { s.innerText = "ACTIU"; s.classList.add('ok'); }
        }
        function activarTot() { ['gps', 'camera', 'micro', 'galeria'].forEach(t => demanarPermis(t)); }
        function revisarPermisos() {
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' }).then(res => { if (res.state === 'granted') marcarOK('gps'); });
            }
        }
    </script>
</body>
</html>
