<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SitgesWalk Pro</title>
    <style>
        :root { --blau-sitges: #0077cc; --blanc: #ffffff; --gris: #f1f3f5; --exit: #28a745; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: var(--gris); overflow: hidden; }
        .screen { display: none; height: 100vh; width: 100%; flex-direction: column; align-items: center; justify-content: center; padding: 25px; box-sizing: border-box; text-align: center; }
        .active { display: flex; }
        #setup { background: white; }
        .permis-box { background: #f8f9fa; padding: 15px; border-radius: 15px; margin: 10px 0; width: 100%; max-width: 320px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; border: 1px solid #eee; }
        .status { font-size: 0.8rem; font-weight: bold; }
        .concedit { color: var(--exit); }
        .btn-principal { background: var(--blau-sitges); color: white; border: none; padding: 18px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,119,204,0.3); margin-top: 20px; width: 100%; max-width: 300px; }
        #chat-window { display: none; position: fixed; bottom: 90px; right: 20px; width: 320px; height: 450px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; z-index: 2000; }
        #chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px; border-radius: 15px; font-size: 0.95rem; max-width: 80%; text-align: left; }
        .bot { background: #e9ecef; align-self: flex-start; }
        .user { background: var(--blau-sitges); color: white; align-self: flex-end; }
        .chat-controls { display: flex; padding: 10px; border-top: 1px solid #eee; background: white; }
        .chat-controls input { flex: 1; border: none; padding: 10px; outline: none; }
        #chat-trigger { position: fixed; bottom: 20px; right: 20px; width: 65px; height: 65px; background: var(--blau-sitges); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="setup" class="screen active">
        <h1>SitgesWalk</h1>
        <p>Configuraci√≥ de l'experi√®ncia</p>
        <div class="permis-box" onclick="demanarPermis('gps')"><span>üåç Localitzaci√≥ GPS</span><span id="st-gps" class="status">PENDENT</span></div>
        <div class="permis-box" onclick="demanarPermis('micro')"><span>üéôÔ∏è Micr√≤fon (Guia)</span><span id="st-micro" class="status">PENDENT</span></div>
        <button class="btn-principal" id="btn-activar">ACTIVAR APP</button>
    </div>

    <div id="menu" class="screen">
        <h2>Hola! Est√†s a Sitges?</h2>
        <button class="btn-principal" id="btn-proper">üìç QUIN MONUMENT √âS?</button>
    </div>

    <div id="chat-window">
        <div style="background:var(--blau-sitges); color:white; padding:15px; display:flex; justify-content:space-between;">
            <span>Guia SitgesWalk</span><span id="chat-close" style="cursor:pointer">‚úï</span>
        </div>
        <div id="chat-messages"></div>
        <div class="chat-controls">
            <input type="text" id="chat-input" placeholder="Pregunta sobre un monument...">
            <button id="btn-enviar" style="background:none; border:none; font-size:1.5rem;">üöÄ</button>
        </div>
    </div>

    <div id="chat-trigger">üí¨</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // LES TEVES CREDENCIALS REALS
        const firebaseConfig = {
            apiKey: "AIzaSyDQwBo1m8hoh1kk2AW7Tex51trJzeDBejU",
            authDomain: "sitgeswalk.firebaseapp.com",
            projectId: "sitgeswalk",
            storageBucket: "sitgeswalk.firebasestorage.app",
            messagingSenderId: "13367453792",
            appId: "1:13367453792:web:ee3a8dbae2df721b8f3b05",
            measurementId: "G-HQQ8SFX99F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- L√íGICA DE L'APP ---
        async function buscarMonumentProper() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const uLat = pos.coords.latitude;
                const uLon = pos.coords.longitude;
                
                const querySnapshot = await getDocs(collection(db, "monuments"));
                let proper = null; let distMin = Infinity;

                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    const dist = Math.sqrt(Math.pow(d.latitud - uLat, 2) + Math.pow(d.longitud - uLon, 2));
                    if (dist < distMin) { distMin = dist; proper = d; }
                });

                if (proper) {
                    obrirChat();
                    const txt = `Est√†s a prop de: ${proper.nom}. ${proper.descripcio}`;
                    afegirMsg(txt, 'bot');
                    parlar(txt);
                }
            });
        }

        async function enviarXat() {
            const input = document.getElementById('chat-input');
            const userText = input.value.trim();
            if (!userText) return;

            afegirMsg(userText, 'user');
            input.value = '';

            const querySnapshot = await getDocs(collection(db, "monuments"));
            let resposta = "No trobo informaci√≥ sobre aquest monument a Sitges.";

            querySnapshot.forEach((doc) => {
                const d = doc.data();
                if (userText.toLowerCase().includes(d.nom.toLowerCase())) {
                    resposta = d.descripcio;
                }
            });

            afegirMsg(resposta, 'bot');
            parlar(resposta);
        }

        function afegirMsg(txt, cl) {
            const m = document.getElementById('chat-messages');
            const d = document.createElement('div');
            d.className = `msg ${cl}`;
            d.innerText = txt;
            m.appendChild(d);
            m.scrollTop = m.scrollHeight;
        }

        function parlar(text) {
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = 'ca-ES';
            window.speechSynthesis.speak(ut);
        }

        function obrirChat() { document.getElementById('chat-window').style.display = 'flex'; }

        // --- EVENTS ---
        document.getElementById('btn-proper').onclick = buscarMonumentProper;
        document.getElementById('btn-enviar').onclick = enviarXat;
        document.getElementById('chat-trigger').onclick = () => {
            const w = document.getElementById('chat-window');
            w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
        };
        document.getElementById('chat-close').onclick = () => document.getElementById('chat-window').style.display = 'none';
        
        document.getElementById('btn-activar').onclick = () => {
            document.getElementById('setup').classList.remove('active');
            document.getElementById('menu').classList.add('active');
            parlar("Benvingut a Sitges Walk. Ja pots comen√ßar la teva ruta.");
        };

        window.demanarPermis = async (tipus) => {
            if (tipus === 'gps') {
                navigator.geolocation.getCurrentPosition(() => {
                    document.getElementById('st-gps').innerText = "CONCEDIT";
                    document.getElementById('st-gps').style.color = "green";
                });
            }
            if (tipus === 'micro') {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                document.getElementById('st-micro').innerText = "CONCEDIT";
                document.getElementById('st-micro').style.color = "green";
            }
        };
    </script>
</body>
</html>
