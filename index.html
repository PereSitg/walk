<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SitgesWalk Pro - Pere Badia i Lorenz</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0056b3; --accent: #28a745; --bg: #f0f2f5; --white: #ffffff; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }

        .screen { display: none; height: 100vh; width: 100vw; flex-direction: column; }
        .screen.active { display: flex; }

        /* SPLASH & SETUP (Mantenen l'estil anterior) */
        #splash, #setup, #ruta-select { align-items: center; justify-content: center; padding: 20px; background: var(--bg); }
        #splash { background: linear-gradient(135deg, #0056b3, #007bff); color: white; }

        /* PANTALLA PRINCIPAL (MAPA FULLSCREEN) */
        #main { position: relative; }
        
        /* CAP√áALERA BLAVA */
        .header-info {
            position: absolute; top: 0; left: 0; right: 0;
            background: var(--primary); color: white;
            padding: 15px; text-align: center; z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header-info h1 { margin: 0; font-size: 1.4rem; letter-spacing: 1px; }
        .header-info p { margin: 5px 0 0; font-size: 0.9rem; opacity: 0.9; font-weight: 300; }

        /* CONTENIDOR DEL MAPA */
        #map-fullscreen { flex: 1; width: 100%; height: 100%; border: none; }

        /* CHATBOT FLOTANT */
        #chat-toggle-btn {
            position: absolute; bottom: 20px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--primary); color: white;
            border: none; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 20;
        }

        #global-chatbot {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 20px 20px 0 0;
            padding: 15px; z-index: 30; transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
        }
        #global-chatbot.open { transform: translateY(0); }
        
        .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #chat-log { height: 120px; overflow-y: auto; font-size: 0.85rem; background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .chat-input-area { display: flex; gap: 8px; }
        #chat-input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; }

        /* ELEMENTS COMUNS */
        .loader { border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; margin-bottom: 8px; }
        .btn-main { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div id="splash" class="screen active">
        <h1>SitgesWalk</h1>
        <p>by Pere Badia i Lorenz</p>
        <div class="loader"></div>
    </div>

    <div id="ruta-select" class="screen">
        <div style="width: 90%; max-width: 400px; text-align: center;">
            <h2>Benvingut, Pere</h2>
            <p>Quina ruta vols explorar avui?</p>
            <button class="btn btn-main" onclick="comencarApp('30min')">‚è±Ô∏è Ruta 30 minuts</button>
            <button class="btn btn-main" onclick="comencarApp('1h')">üö∂ Ruta 1 hora</button>
            <button class="btn btn-main" onclick="comencarApp('completa')">‚≠ê Ruta Completa</button>
        </div>
    </div>

    <div id="main" class="screen">
        <div class="header-info">
            <h1>SitgesWalk</h1>
            <p id="current-street">Detectant carrer...</p>
        </div>

        <iframe id="map-fullscreen" src="" allow="geolocation"></iframe>

        <button id="chat-toggle-btn" onclick="toggleChat()">ü§ñ</button>

        <div id="global-chatbot">
            <div class="chat-header">
                <strong>Guia Virtual</strong>
                <button onclick="toggleChat()" style="border:none; background:none; font-size:1.2rem;">‚úñ</button>
            </div>
            <div id="chat-log">ü§ñ Hola Pere! Estic a punt.</div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Pregunta'm...">
                <button class="btn-main" style="width:50px; padding:10px; margin:0" onclick="enviarXat()">‚úàÔ∏è</button>
            </div>
        </div>
    </div>

    <script>
        // --- GEOLOCALITZACI√ì REVERSA (Per saber el carrer) ---
        async function obtenirCarrer(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                const carrer = data.address.road || data.address.pedestrian || "Sitges";
                document.getElementById('current-street').innerText = "üìç " + carrer;
            } catch (error) {
                document.getElementById('current-street').innerText = "üìç Passeig de la Ribera";
            }
        }

        // --- NAVEGACI√ì ---
        setTimeout(() => {
            canviarPantalla('splash', 'ruta-select');
        }, 3000);

        function canviarPantalla(actual, seguent) {
            document.getElementById(actual).classList.remove('active');
            document.getElementById(seguent).classList.add('active');
        }

        function comencarApp(temps) {
            canviarPantalla('ruta-select', 'main');
            iniciarSeguiment();
            parlar("Ruta iniciada. T'anir√© indicant els carrers.");
        }

        // --- SEGUIMENT GPS ---
        function iniciarSeguiment() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((p) => {
                    const lat = p.coords.latitude;
                    const lon = p.coords.longitude;
                    
                    // Actualitzar Mapa H√≠brid (Sat√®l¬∑lit)
                    document.getElementById('map-fullscreen').src = `https://www.google.com/maps/embed/v1/view?key=TEVA_API_KEY_OPCIONAL&center=${lat},${lon}&zoom=18&maptype=satellite`;
                    
                    // Si no tens clau API, usem el m√®tode embed est√†ndard:
                    document.getElementById('map-fullscreen').src = `https://maps.google.com/maps?q=${lat},${lon}&t=k&z=18&output=embed`;

                    // Actualitzar carrer
                    obtenirCarrer(lat, lon);
                }, null, { enableHighAccuracy: true });
            }
        }

        // --- CHATBOT LOGIC ---
        function toggleChat() {
            document.getElementById('global-chatbot').classList.toggle('open');
        }

        function enviarXat() {
            const i = document.getElementById('chat-input');
            const l = document.getElementById('chat-log');
            if(i.value) {
                l.innerHTML += `<div><b>Tu:</b> ${i.value}</div>`;
                const r = "Perfecte Pere, estem al carrer que marca a dalt. Seguim!";
                l.innerHTML += `<div><b>ü§ñ:</b> ${r}</div>`;
                parlar(r);
                i.value = "";
                l.scrollTop = l.scrollHeight;
            }
        }

        function parlar(t) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'ca-ES';
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
