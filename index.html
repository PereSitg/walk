<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SitgesWalk Pro - Pere Badia i Lorenz</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0056b3;
            --accent: #28a745;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #1c1e21;
            --radius: 18px;
            --shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text); }

        .screen { display: none; min-height: 100vh; padding: 24px; flex-direction: column; align-items: center; animation: fadeIn 0.4s ease; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .container { width: 100%; max-width: 420px; }
        .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; width: 100%; margin-bottom: 20px; }

        /* Botons */
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
        .btn-main { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-outline { background: white; border: 2px solid #e4e6eb; color: var(--text); font-size: 0.9rem; }
        
        /* Graella de permisos */
        .permisos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .status-box { font-size: 0.8rem; background: #f8f9fa; padding: 10px; border-radius: 10px; margin-top: 10px; }
        .status-item { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .status-item span { font-weight: 700; color: #999; }
        .ok { color: var(--accent) !important; }

        /* Pantalla Main */
        .image-header { width: 100%; height: 160px; background-size: cover; background-position: center; border-radius: 14px; margin-bottom: 15px; background-color: #ddd; }
        #map-container { border-radius: 14px; overflow: hidden; height: 160px; border: 1px solid #ddd; margin: 10px 0; }
        .desc-box { background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 5px solid var(--primary); font-size: 0.9rem; max-height: 120px; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="splash" class="screen active" style="background: var(--primary); color: white; justify-content: center;">
        <h1>SitgesWalk</h1>
        <p>by Pere Badia i Lorenz</p>
    </div>

    <div id="setup" class="screen">
        <div class="container">
            <h1 style="text-align: center;">Configuraci√≥</h1>
            <p style="text-align: center; color: #666;">Tria quins serveis vols activar:</p>
            
            <button class="btn btn-success" onclick="activarTot()">‚úÖ ACTIVAR-HO TOT DE COP</button>

            <div class="permisos-grid">
                <button class="btn btn-outline" onclick="demanarPermis('gps')">üåç GPS</button>
                <button class="btn btn-outline" onclick="demanarPermis('camera')">üì∑ C√†mera</button>
                <button class="btn btn-outline" onclick="demanarPermis('micro')">üéôÔ∏è Micro</button>
                <button class="btn btn-outline" onclick="demanarPermis('galeria')">üñºÔ∏è Galeria</button>
            </div>

            <div class="card status-box">
                <div class="status-item" id="st-gps">Ubicaci√≥: <span>PENDENT</span></div>
                <div class="status-item" id="st-camera">C√†mera: <span>PENDENT</span></div>
                <div class="status-item" id="st-micro">Micr√≤fon: <span>PENDENT</span></div>
                <div class="status-item" id="st-galeria">Galeria: <span>PENDENT</span></div>
            </div>

            <button class="btn btn-main" onclick="anarARuta()" style="margin-top: 15px;">CONTINUAR ‚ûî</button>
        </div>
    </div>

    <div id="ruta-select" class="screen">
        <div class="container">
            <h1 style="text-align: center;">Quina ruta vols fer?</h1>
            <div class="card">
                <button class="btn btn-outline" onclick="comencarApp('30min')">‚è±Ô∏è Ruta r√†pida (30 min)</button>
                <button class="btn btn-outline" onclick="comencarApp('1h')">üö∂ Ruta est√†ndard (1h)</button>
                <button class="btn btn-main" onclick="comencarApp('completa')">‚≠ê Ruta Completa</button>
            </div>
        </div>
    </div>

    <div id="main" class="screen">
        <div class="container">
            <div class="card">
                <div id="mon-imatge" class="image-header"></div>
                <span id="badge-ruta" style="font-size: 0.7rem; font-weight: 700; color: var(--primary); text-transform: uppercase;">SITGESWALK PRO</span>
                <h1 id="mon-nom" style="margin: 5px 0;">Busca un monument</h1>
                
                <div id="map-container">
                    <iframe id="mini-mapa" width="100%" height="100%" frameborder="0"></iframe>
                </div>

                <div class="desc-box">
                    <p id="mon-desc">Carregant informaci√≥...</p>
                </div>

                <div style="margin-top: 15px;">
                    <button class="btn btn-main" id="btn-com-arribar" style="background: #4285F4; display: none;" onclick="obrirGoogleMaps()">üó∫Ô∏è GOOGLE MAPS</button>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-outline" id="btn-escoltar" style="flex: 1;">üîä AUDIO</button>
                        <button class="btn btn-success" id="btn-seguent-punt" style="flex: 1; display: none;" onclick="seguentPuntRuta()">‚è≠Ô∏è SEG√úENT</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- COPIA AQU√ç EL TEU CODI DE FIREBASE I L√íGICA ---
        // Recorda mantenir les funcions: activarTot(), demanarPermis(tipus), mostrarMonument(m), etc.
        // He adaptat la funci√≥ marcarOK perqu√® funcioni amb els nous IDs.

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQwBo1m8hoh1kk2AW7Tex51trJzeDBejU",
            authDomain: "sitgeswalk.firebaseapp.com",
            projectId: "sitgeswalk",
            storageBucket: "sitgeswalk.firebasestorage.app",
            messagingSenderId: "13367453792",
            appId: "1:13367453792:web:ee3a8dbae2df721b8f3b05"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let monumentTrobat = null;
        let llistaPuntsRuta = [];
        let indexPunt = 0;

        // Gesti√≥ de permisos individualitzada
        window.demanarPermis = async (tipus) => {
            const span = document.querySelector(`#st-${tipus} span`);
            span.innerText = "DEMANANT...";
            try {
                if (tipus === 'gps') {
                    navigator.geolocation.getCurrentPosition(() => marcarOK('gps'), () => span.innerText = "DENEGAT");
                } else if (tipus === 'camera' || tipus === 'micro') {
                    const s = await navigator.mediaDevices.getUserMedia(tipus === 'camera' ? {video:true} : {audio:true});
                    s.getTracks().forEach(t => t.stop());
                    marcarOK(tipus);
                } else {
                    marcarOK('galeria'); // Simulat
                }
            } catch (e) { span.innerText = "ERROR"; }
        };

        function marcarOK(tipus) {
            const span = document.querySelector(`#st-${tipus} span`);
            if(span) { span.innerText = "ACTIU"; span.className = "ok"; }
        }

        window.activarTot = async () => {
            await demanarPermis('gps');
            await demanarPermis('camera');
            await demanarPermis('micro');
            await demanarPermis('galeria');
        };

        // L√≤gica de navegaci√≥ (com abans)
        window.anarARuta = () => { document.getElementById('setup').classList.remove('active'); document.getElementById('ruta-select').classList.add('active'); };
        
        window.comencarApp = async (tipus) => {
            document.getElementById('ruta-select').classList.remove('active');
            document.getElementById('main').classList.add('active');
            const querySnapshot = await getDocs(collection(db, "monuments"));
            llistaPuntsRuta = [];
            querySnapshot.forEach(doc => llistaPuntsRuta.push(doc.data()));
            if(llistaPuntsRuta.length > 0) {
                document.getElementById('btn-seguent-punt').style.display = "flex";
                document.getElementById('btn-com-arribar').style.display = "flex";
                mostrarMonument(llistaPuntsRuta[0]);
            }
        };

        function mostrarMonument(m) {
            monumentTrobat = m;
            document.getElementById('mon-nom').innerText = m.nom;
            document.getElementById('mon-desc').innerText = m.descripcio;
            document.getElementById('mini-mapa').src = `https://www.openstreetmap.org/export/embed.html?bbox=${m.longitud-0.001},${m.latitud-0.001},${m.longitud+0.001},${m.latitud+0.001}&layer=mapnik&marker=${m.latitud},${m.longitud}`;
            if(m.imatge) document.getElementById('mon-imatge').style.backgroundImage = `url(${m.imatge})`;
        }

        window.obrirGoogleMaps = () => {
            if (monumentTrobat) window.open(`https://www.google.com/maps/dir/?api=1&destination=${monumentTrobat.latitud},${monumentTrobat.longitud}&travelmode=walking`, '_blank');
        };

        window.seguentPuntRuta = () => {
            indexPunt = (indexPunt + 1) % llistaPuntsRuta.length;
            mostrarMonument(llistaPuntsRuta[indexPunt]);
        };

        setTimeout(() => { document.getElementById('splash').classList.remove('active'); document.getElementById('setup').classList.add('active'); }, 2000);
    </script>
</body>
</html>
