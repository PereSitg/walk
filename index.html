<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SitgesWalk Pro - Pere Badia i Lorenz</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0056b3; --accent: #28a745; --bg: #f0f2f5; --card: #ffffff; --radius: 18px; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background-color: var(--bg); color: #1c1e21; padding-bottom: 180px; }

        .screen { display: none; min-height: 100vh; padding: 20px; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }

        #splash { background: linear-gradient(135deg, #0056b3, #007bff); color: white; justify-content: center; text-align: center; }
        .loader { border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .container { width: 100%; max-width: 400px; }
        .card { background: var(--card); border-radius: var(--radius); padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; margin-bottom: 15px; }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; margin-bottom: 8px; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-outline { background: white; border: 2px solid #ddd; }

        #global-chatbot {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 2px solid var(--primary);
            padding: 10px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            display: none;
        }
        #chat-log { height: 80px; overflow-y: auto; font-size: 0.85rem; background: #f8f9fa; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; }
        .chat-input-area { display: flex; gap: 5px; }
        #chat-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }

        #map-container { width: 100%; height: 220px; border-radius: 12px; overflow: hidden; border: 1px solid #ddd; margin: 10px 0; background: #eee; }
        .ok { color: var(--accent) !important; font-weight: bold; }
    </style>
</head>
<body>

    <div id="splash" class="screen active">
        <h1>SitgesWalk</h1>
        <p>by Pere Badia i Lorenz</p>
        <div class="loader"></div>
    </div>

    <div id="setup" class="screen">
        <div class="container">
            <h2 style="text-align:center">Configuraci√≥</h2>
            <button class="btn btn-success" onclick="activarTot()">‚úÖ ACTIVAR TOT DE COP</button>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0;">
                <button class="btn btn-outline" onclick="demanarPermis('gps')">üåç GPS</button>
                <button class="btn btn-outline" onclick="demanarPermis('camera')">üì∑ C√†mera</button>
                <button class="btn btn-outline" onclick="demanarPermis('micro')">üéôÔ∏è Micro</button>
                <button class="btn btn-outline" onclick="demanarPermis('galeria')">üñºÔ∏è Galeria</button>
            </div>
            <div class="card" style="font-size: 0.8rem;">
                <div id="st-gps">Ubicaci√≥: <span>PENDENT</span></div>
                <div id="st-camera">C√†mera: <span>PENDENT</span></div>
                <div id="st-micro">Micro: <span>PENDENT</span></div>
                <div id="st-galeria">Galeria: <span>PENDENT</span></div>
            </div>
            <button class="btn btn-main" onclick="canviarPantalla('setup', 'ruta-select')">CONTINUAR ‚ûî</button>
        </div>
    </div>

    <div id="ruta-select" class="screen">
        <div class="container">
            <h2>Quina ruta vols fer?</h2>
            <div class="card">
                <button class="btn btn-outline" onclick="comencarApp('30min')">‚è±Ô∏è 30 minuts</button>
                <button class="btn btn-outline" onclick="comencarApp('1h')">üö∂ 1 hora</button>
                <button class="btn btn-outline" onclick="comencarApp('2h')">üëü 2 hores</button>
                <button class="btn btn-main" onclick="comencarApp('completa')">‚≠ê Ruta Completa</button>
            </div>
        </div>
    </div>

    <div id="main" class="screen">
        <div class="container">
            <div class="card">
                <h3 id="mon-nom" style="margin:0">Esgl√©sia de Sant Bartomeu</h3>
                <div id="map-container">
                    <iframe id="mini-mapa" width="100%" height="100%" frameborder="0" style="border:0"></iframe>
                </div>
                <p id="mon-desc" style="font-size: 0.9rem; border-left: 4px solid var(--primary); padding-left: 10px;">
                    Benvingut a la Punta de Sitges. Aquesta esgl√©sia del segle XVII √©s la imatge m√©s ic√≤nica de la vila.
                </p>
                <button class="btn btn-main" onclick="identificarPerGPS()">üìç RE-LOCALITZAR GPS</button>
            </div>
        </div>
    </div>

    <div id="global-chatbot">
        <div id="chat-log">ü§ñ Hola Pere! Soc el teu guia. Digues "Hola" o demana'm informaci√≥.</div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Escriu aqu√≠...">
            <button class="btn btn-main" style="width:50px; margin:0" onclick="enviarXat()">‚úàÔ∏è</button>
            <button class="btn btn-success" style="width:50px; margin:0" onclick="escoltarVeu()">üé§</button>
        </div>
    </div>

    <script>
        // --- MOTOR DEL CHATBOT (RESPOSTES REALS) ---
        function generarResposta(pregunta) {
            const p = pregunta.toLowerCase();
            if (p.includes("hola")) return "Hola Pere! Estic a punt per guiar-te per Sitges. Qu√® vols visitar?";
            if (p.includes("esgl√©sia") || p.includes("punta")) return "L'esgl√©sia de Sant Bartomeu i Santa Tecla √©s del segle disset i t√© un estil barroc preci√≥s.";
            if (p.includes("ruta")) return "Estem fent la ruta per la fa√ßana mar√≠tima. Segueix el mapa!";
            if (p.includes("qui ets")) return "Soc l'assistent virtual de SitgesWalk, creat per Pere Badia.";
            return "No estic segur de l'explicaci√≥ de '" + pregunta + "', per√≤ podem anar a la Punta a veure les vistes!";
        }

        // --- NAVEGACI√ì ---
        setTimeout(() => {
            document.getElementById('splash').classList.remove('active');
            document.getElementById('setup').classList.add('active');
            document.getElementById('global-chatbot').style.display = 'block';
            revisarPermisos();
        }, 3000);

        function canviarPantalla(actual, seguent) {
            document.getElementById(actual).classList.remove('active');
            document.getElementById(seguent).classList.add('active');
        }

        function comencarApp(temps) {
            canviarPantalla('ruta-select', 'main');
            identificarPerGPS(); // For√ßa l'inici del mapa
            const msg = "Perfecte. Iniciem la ruta de " + temps + ". Segueix el punt blau al mapa.";
            afegirAlLog(msg, "ü§ñ");
            parlar(msg);
        }

        // --- SISTEMA DE XAT ---
        function enviarXat() {
            const i = document.getElementById('chat-input');
            const text = i.value.trim();
            if(!text) return;

            afegirAlLog(text, "Tu");
            const resposta = generarResposta(text);
            
            setTimeout(() => {
                afegirAlLog(resposta, "ü§ñ");
                parlar(resposta);
            }, 600)
            
            i.value = "";
        }

        function afegirAlLog(text, autor) {
            const l = document.getElementById('chat-log');
            l.innerHTML += `<div><b>${autor}:</b> ${text}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        function parlar(t) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'ca-ES';
            u.rate = 1;
            window.speechSynthesis.speak(u);
        }

        function escoltarVeu() {
            const rec = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
            rec.lang = 'ca-ES';
            rec.onresult = (e) => { 
                document.getElementById('chat-input').value = e.results[0][0].transcript; 
                enviarXat(); 
            };
            rec.start();
        }

        // --- MAPA I GPS ---
        function identificarPerGPS() {
            navigator.geolocation.getCurrentPosition((p) => {
                const lat = p.coords.latitude;
                const lon = p.coords.longitude;
                // Google Maps H√≠brid (Sat√®l¬∑lit + Etiquetes)
                const url = `https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d1500!2d${lon}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e1!3m2!1sca!2ses!4v1700000000000!5m2!1sca!2ses&maptype=satellite`;
                document.getElementById('mini-mapa').src = url;
                marcarOK('gps');
            }, (err) => {
                console.log("Error GPS");
            });
        }

        // --- PERMISOS ---
        function demanarPermis(t) {
            if(t === 'gps') identificarPerGPS();
            else marcarOK(t);
        }

        function marcarOK(t) {
            const s = document.querySelector(`#st-${t} span`);
            if(s) { s.innerText = "ACTIU"; s.classList.add('ok'); }
        }

        function activarTot() {
            ['gps', 'camera', 'micro', 'galeria'].forEach(t => demanarPermis(t));
        }

        function revisarPermisos() {
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' }).then(res => {
                    if (res.state === 'granted') marcarOK('gps');
                });
            }
        }
    </script>
</body>
</html>
