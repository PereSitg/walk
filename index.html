<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SitgesWalk Pro - Pere Badia i Lorenz</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0056b3; --accent: #28a745; --bg: #f0f2f5; --card: #ffffff; --radius: 18px; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background-color: var(--bg); color: #1c1e21; padding-bottom: 180px; }

        .screen { display: none; min-height: 100vh; padding: 20px; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }

        /* SPLASH */
        #splash { background: linear-gradient(135deg, #0056b3, #007bff); color: white; justify-content: center; text-align: center; }
        .loader { border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* TARGETES I BOTONS */
        .container { width: 100%; max-width: 400px; }
        .card { background: var(--card); border-radius: var(--radius); padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; margin-bottom: 15px; }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; margin-bottom: 8px; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-outline { background: white; border: 2px solid #ddd; }

        /* CHATBOT PERMANENT */
        #global-chatbot {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 2px solid var(--primary);
            padding: 10px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            display: none;
        }
        #chat-log { height: 70px; overflow-y: auto; font-size: 0.8rem; background: #f8f9fa; padding: 8px; border-radius: 8px; margin-bottom: 8px; }
        .chat-input-area { display: flex; gap: 5px; }
        #chat-input { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; }

        /* MAPA H√çBRID */
        #map-container { width: 100%; height: 200px; border-radius: 12px; overflow: hidden; border: 1px solid #ddd; margin: 10px 0; }
        .ok { color: var(--accent) !important; font-weight: bold; }
    </style>
</head>
<body>

    <div id="splash" class="screen active">
        <h1>SitgesWalk</h1>
        <p>by Pere Badia i Lorenz</p>
        <div class="loader"></div>
    </div>

    <div id="setup" class="screen">
        <div class="container">
            <h2 style="text-align:center">Configuraci√≥ Pro</h2>
            <button class="btn btn-success" onclick="activarTot()">‚úÖ ACTIVAR TOT DE COP</button>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0;">
                <button class="btn btn-outline" onclick="demanarPermis('gps')">üåç GPS</button>
                <button class="btn btn-outline" onclick="demanarPermis('camera')">üì∑ C√†mera</button>
                <button class="btn btn-outline" onclick="demanarPermis('micro')">üéôÔ∏è Micro</button>
                <button class="btn btn-outline" onclick="demanarPermis('galeria')">üñºÔ∏è Galeria</button>
            </div>
            <div class="card" style="font-size: 0.8rem;">
                <div id="st-gps">Ubicaci√≥: <span>PENDENT</span></div>
                <div id="st-camera">C√†mera: <span>PENDENT</span></div>
                <div id="st-micro">Micro: <span>PENDENT</span></div>
                <div id="st-galeria">Galeria: <span>PENDENT</span></div>
            </div>
            <button class="btn btn-main" onclick="canviarPantalla('setup', 'ruta-select')">CONTINUAR ‚ûî</button>
        </div>
    </div>

    <div id="ruta-select" class="screen">
        <div class="container">
            <h2>Quina ruta vols fer?</h2>
            <div class="card">
                <button class="btn btn-outline" onclick="comencarApp('30min')">‚è±Ô∏è 30 minuts (R√†pida)</button>
                <button class="btn btn-outline" onclick="comencarApp('1h')">üö∂ 1 hora (Est√†ndard)</button>
                <button class="btn btn-outline" onclick="comencarApp('2h')">üëü 2 hores (Extensa)</button>
                <button class="btn btn-main" onclick="comencarApp('completa')">‚≠ê Ruta Completa</button>
            </div>
        </div>
    </div>

    <div id="main" class="screen">
        <div class="container">
            <div class="card">
                <h3 id="mon-nom" style="margin:0">Busca un monument</h3>
                <div id="map-container">
                    <iframe id="mini-mapa" width="100%" height="100%" frameborder="0" style="border:0"></iframe>
                </div>
                <p id="mon-desc" style="font-size: 0.9rem; border-left: 4px solid var(--primary); padding-left: 10px;">
                    Prem el bot√≥ GPS per detectar on ets.
                </p>
                <button class="btn btn-main" onclick="identificarPerGPS()">üìç RE-LOCALITZAR PER GPS</button>
            </div>
        </div>
    </div>

    <div id="global-chatbot">
        <div id="chat-log">ü§ñ Hola Pere! Soc el teu guia. Digues "Hola" per comen√ßar.</div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Pregunta'm...">
            <button class="btn btn-main" style="width:50px; margin:0" onclick="enviarXat()">‚úàÔ∏è</button>
            <button class="btn btn-success" style="width:50px; margin:0" onclick="escoltarVeu()">üé§</button>
        </div>
    </div>

    <script>
        // --- REVISI√ì AUTOM√ÄTICA DE GPS EN ENTRAR ---
        function revisarGPSAutomaticament() {
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
                    if (result.state === 'granted') {
                        marcarOK('gps');
                        identificarPerGPS(); // Carrega el mapa directament
                    }
                    result.onchange = function() {
                        if (result.state === 'granted') { marcarOK('gps'); identificarPerGPS(); }
                    };
                });
            }
        }

        // --- NAVEGACI√ì ---
        setTimeout(() => {
            document.getElementById('splash').classList.remove('active');
            document.getElementById('setup').classList.add('active');
            document.getElementById('global-chatbot').style.display = 'block';
            revisarGPSAutomaticament(); // Revisa si el GPS ja estava actiu
        }, 3000);

        function canviarPantalla(actual, seg√ºent) {
            document.getElementById(actual).classList.remove('active');
            document.getElementById(seg√ºent).classList.add('active');
        }

        function comencarApp(temps) {
            canviarPantalla('ruta-select', 'main');
            document.getElementById('chat-log').innerHTML += `<div>ü§ñ Ruta: ${temps}. Comencem!</div>`;
        }

        // --- MAPA H√çBRID ---
        function actualitzarMapa(lat, lon) {
            // Capa 'y' de Google Maps √©s l'H√çBRIDA (Sat√®l¬∑lit + Etiquetes)
            const url = `https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}`; // Placeholder conceptual
            // Per a l'iframe usarem la versi√≥ d'incrustaci√≥ h√≠brida:
            const embedUrl = `https://maps.google.com/maps?q=${lat},${lon}&t=h&z=18&output=embed`;
            document.getElementById('mini-mapa').src = embedUrl;
        }

        // --- CHATBOT ---
        function parlar(t) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'ca-ES';
            window.speechSynthesis.speak(u);
        }

        function enviarXat() {
            const i = document.getElementById('chat-input');
            const l = document.getElementById('chat-log');
            if(i.value) {
                l.innerHTML += `<div><b>Tu:</b> ${i.value}</div>`;
                const r = "D'acord Pere, busco dades sobre " + i.value;
                l.innerHTML += `<div><b>ü§ñ:</b> ${r}</div>`;
                parlar(r);
                i.value = "";
                l.scrollTop = l.scrollHeight;
            }
        }

        function escoltarVeu() {
            const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            rec.lang = 'ca-ES';
            rec.onresult = (e) => { document.getElementById('chat-input').value = e.results[0][0].transcript; enviarXat(); };
            rec.start();
        }

        // --- PERMISOS ---
        function demanarPermis(t) {
            if(t === 'gps') {
                navigator.geolocation.getCurrentPosition((p) => {
                    marcarOK('gps');
                    actualitzarMapa(p.coords.latitude, p.coords.longitude);
                }, (err) => console.log("GPS denegat"));
            } else { marcarOK(t); }
        }
        
        function marcarOK(t) { 
            const s = document.querySelector(`#st-${t} span`);
            if(s) { s.innerText = "ACTIU"; s.className = "ok"; }
        }

        function activarTot() { ['gps', 'camera', 'micro', 'galeria'].forEach(t => demanarPermis(t)); }
        
        function identificarPerGPS() {
            navigator.geolocation.getCurrentPosition((p) => actualitzarMapa(p.coords.latitude, p.coords.longitude));
        }
    </script>
</body>
</html>
